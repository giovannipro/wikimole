<html>
	<body>
		<!-- Script works if loaded by MAMP -->
		<title>Page views</title>
		<script src="../lib/js/jquery.min.js"></script>
		<script src="../lib/js/jquery.xdomainajax.js"></script>
		<link rel="stylesheet" href="../lib/css/scraper.css" rel="stylesheet">
		<script type="text/javascript">

			// var interlink = 'http://localhost:8888/wikimole/scraper/proxy/proxy_interlinks.php?url=nelson_mandela';
			// var whatlinks = 'https://en.wikipedia.org/w/api.php?action=query&list=backlinks&bllimit=500&format=json&bltitle=nelson_mandela';

			var yearPV = {};

			var allPV = {};

	        /* ------------------------------------
			SOURCE
	        -------------------------------------*/

	        var baseurl = 'http://localhost:8888/wikimole/scraper/proxy/';

	        var proxy = baseurl + 'proxy_pageviews.php' + "?url=" ;

	        //var wikilink = 'https://en.wikipedia.org/wiki/';

	        var service = "http://stats.grok.se/json/en/"; // '201506/nelson_mandela

	        //var proxy_service = proxy + service;

	        /* ------------------------------------
			ARTICLES LIST
	        -------------------------------------*/

			var art_list = '../articles/articles_test.json' // '../articles.json'

			var list = [
				'nelson_mandela', //https://en.wikipedia.org/wiki/
				'mahatma_gandhi' //'Human_swimming'
			]	

			// get the list of articles
			$.getJSON(art_list, function(mydata) {

				var parse_art = $.parseHTML(mydata);

				articles = $(mydata)

				//console.log( articles )
			
			})

	        /* ------------------------------------
	        GET ONE MONTH
	        -------------------------------------*/

	        var article_a = "Bullying" //nelson_mandela; Bullying; Gender

	        //function get_one_month_pageview(url) {
	        function get_one_month_pageview(yearString, monthString, article, doPrint) { //dateString
				
				var container = $('#' + article);

	        	var url1 = proxy + service + yearString + monthString +  '/' + article
	        	var url2 = service + yearString + monthString +  '/' + article

	        	var url_test = 'http://localhost:8888/wikimole/scraper/lib/test.json'
	        	//console.log(url1)

	  		    $.ajax({			    	
		           	type: 'GET',
		           	url: url1,
		           	processData: true,
		           	dataType: 'json', // html
		           	crossOrigin: true,
		        })
				.done (function (wikiResponse) {
					if (!yearPV.hasOwnProperty(yearString)) {
						yearPV[yearString] = {};
					}

					yearPV[yearString][monthString] = wikiResponse.daily_views;


					if (doPrint)
						console.log(yearPV[yearString]);

					//console.log(yearPV[yearString][monthString])


					jQuery.each( yearPV[yearString][monthString], function( i, v ) { // 

						
						container.append('<tr><td>' + article + '</td><td>' + i +'</td><td>' + v +'</tr>')

						/*
	
						for csv to json converter
						{f2}":{f3}

						*/

						//container.append(article + ',' + i +',' + v )

				    	/*
				    	container.append( '<tr><td>article</td><td>' + i  +'</td></tr>');
				    	container.append( '<tr><td>' +  article + ',</td><td>' + v + '</td></tr>');
				    	*/

				    	//container.append( '<tr><td>' +  article + ',</td><td>' + i  + ',</td><td>' + v + '</td></tr>');

				    	//container.append( '<div>' + i  + '</div><div>' + v + '</div>');

				    })

				})
				.error (function (xhr, ajaxOptions, thrownError) {
			        console.log(xhr.status);
			        console.log(thrownError);
			        /*
						200 OK
						301 Moved Permanently
						400 Bad Request
						401 Unauthorized
						403 Forbidden
						404 Not Found
						500 Internal Server Error
						503 Service Unavailable
			        */
				})
			};

			function get_monthly_pageview(article) {

				//console.log(article)
				var container = $('#pageviews');

				$('.hide_1').hide()

				//container.append('<tr><td>' + article + '</td></tr>')
				//container.append( article )

				//container.append(article + ',')

				//container.append('[{"article":"' + article + '"},{<br/>')
				
				for (i = 1; i < 10; i++) { 

					var yearString = '2014' ;
					var monthString = '0'+i ;

					get_one_month_pageview(yearString, monthString, article); // , monthString === '12';
				}
				
				for (i = 10; i < 13; i++) {

					var yearString = '2014' ;
					var monthString =  i + '';

					get_one_month_pageview(yearString, monthString, article, monthString === '12'); 

				}
				
				/*for (i = 12; i < 13; i++) {

					var yearString = '2013' ;
					var monthString =  i + '';

					get_one_month_pageview(yearString, monthString, article, monthString === '12'); 

				}*/
				
				//get_csv(yearString,monthString)

			}

			function get_all_monthly_pageview(yearString,article) {

	        	//$('#source_target').html('Source,Target<br/>')
	        	var container = $('#pageviews_1');

				jQuery.each( list, function( i, val ) { //articles; list;

					//container.append('<tr><td>' + val + '</td></tr>')

					container.append('<table id="' + val + '" style="float:left; width:20%; font-size:10px;"><tr></tr></table>')

					get_monthly_pageview( val )

					allPV[yearPV]  = yearPV;

					console.log(allPV)
					
				})

			}

			//console.log(yearPV)

			/*

			function get_csv(article) {

				get_monthly_pageview(article)

				var container = $('#pageviews');

				jQuery.each( yearPV[2014], function( i, v ) {

					//container.append( '"' + i  + '":' + v + ',<br/>');
					//console.log(i + ':' + v)
					
					container.append( '"' + i  + '":' + v + ',');
					//console.log( '"' + i  + '":' + v + ',');

				})

				container.append('}]')

			}

			//get_csv(article_a)*/

		</script>

		<main>
			<div id="title" class="hide_1">
				<h1>Page views<h1>
				<h2>From 1.12.2013 to 31.07.2015</h2>
			</div>
			<div class="box_100">
				<div class="label one hide_1" onclick="get_all_monthly_pageview()" style="">
					<span>Get pageviews</span>
					<!-- to be sure each edge is downloaded see Firebug > Network > Time column-->
				</div><!-- get_all_source_target()-->
				<div id="tit" class="hide_2"></div>
				<div class="hide_2">
					<table id="pageviews_1"></table>
					<!--<table id="pageviews" style="font-size:10px"></table>-->
				</div>
				<div id="content1" class="hide_2" onclick="hide()"></div>
			</div>
			<div class="clear"></div>
		</main>

	</body>
</html>