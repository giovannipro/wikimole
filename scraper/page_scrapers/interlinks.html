<html>
	<body>
		<!-- Script works if loaded by MAMP -->
		<title>Interlinks</title>
		<script src="../lib/js/jquery.min.js"></script>
		<script src="../lib/js/jquery.xdomainajax.js"></script>
		<link rel="stylesheet" href="../lib/css/scraper.css" rel="stylesheet">
		<script type="text/javascript">

	        /* ------------------------------------
			SOURCE
	        -------------------------------------*/

	        var baseurl = 'http://localhost:8888/wikimole/scraper/proxy/';

	        var backlinks = 'https://en.wikipedia.org/w/api.php?action=query&list=backlinks&bllimit=500&format=json&bltitle=';

	        /*
	        https://en.wikipedia.org/w/api.php?action=query&list=backlinks&bllimit=500&format=json&bltitle=food
	        https://en.wikipedia.org/w/api.php?action=query&list=backlinks&bllimit=500&format=json&batchcomplete=&bltitle=food
			*/

	        var proxy = baseurl + 'proxy_interlinks.php' + "?url=" ;

	        var wikilink = 'https://en.wikipedia.org/wiki/';

	        /* ------------------------------------
			FINDME
	        -------------------------------------*/

	        var origin = window.location.origin + '/wiki/';

			var findme =  origin;
			var findme1 = origin + 'User:';
			var findme2 = origin + 'Template';
			var findme3 = origin + 'Talk:';
			var findme4 = origin + 'Help:';
			var findme5 = origin + 'File:';
			var findme6 = origin + 'Wikipedia:'
			var findme7 = origin + 'Category:'

	        /* ------------------------------------
			ARTICLES LIST
	        -------------------------------------*/

			var art_list = '../articles/articles.json' // '../article_test.json'

			var list = [
				'nelson_mandela',  // nelson_mandela
				'Freedom Day (South Africa)'  // mahatma_gandhi
			]	


			// get the list of articles
			$.getJSON(art_list, function(mydata) {

				var parse_art = $.parseHTML(mydata);

				articles = $(mydata)

				// console.log( articles )
			
			})

	        /* ------------------------------------
	        SOURCE - TARGET 
	        -------------------------------------*/
 
			function scrape_interlinks(url) {
			    
			    $.ajax({			    	
		           	type: 'GET',
		           	url: proxy + wikilink + url,
		           	processData: true,
		           	//dataType: 'json',
		           	//crossOrigin: true,
		        })
		        .done (function (get_func) {

		        	var parsedata_func = $.parseHTML(get_func);

		        	get = []
					get = ($(parsedata_func).find('#mw-content-text').find('a')) //.find('#content')

					//console.log(get)

					jQuery.each( get, function( i, val ) {

						//var cont = val;	
						var url_clean = url.replace('https://en.wikipedia.org/wiki/','').replace(/^-+/, '').replace(/-+$/, '').replace('%C7%83', '!').replace(/_/g, ' ').replace('%28', '(').replace('%29', ')').replace('%27', "'");

						txt = $(this).prop('outerHTML')

						//console.log(val)

						container = $('#source_target');
						var href = $(val).prop('href');

						//console.log(href)

						var href_clean = href.replace('http://localhost:8888/wiki/','').replace(/_/g, ' ').replace(/,/g, ';');

						if (typeof href === 'string' && href.indexOf(findme) === 0 )  {

							//container.append ('<span class="red">' + url_clean + '</span>,' + href_clean  + '</br>' );
							
							if (href.indexOf(findme1) !== 0  && href.indexOf(findme2) !== 0 && href.indexOf(findme3) !== 0 && href.indexOf(findme4) !== 0 && href.indexOf(findme5) !== 0 && href.indexOf(findme6) !== 0)  {

								container.append ('<span class="red">' + url_clean + '</span>,' + href_clean  + '</br>' );
								//container.append ('<span class="red">' + url_clean + '</span>,' + href_clean  + '</br>' );
								//container.append ('si-' + href_clean + '<br/>')
							}
							else {
								console.log('no-' + href_clean )
								
							}
						
						}

					})

					$('.hide_1').hide()

				})
				.error (function (xhr, ajaxOptions, thrownError) {
			        console.log(xhr.status);
			        console.log(thrownError);
				});

			}

	        // get backlinks list for one article
			function get_source_target() {

				$('#source_target').html('Source,Target<br/>')

				jQuery.each( articles, function( i, val ) { //  list

					//var link = val
					scrape_interlinks( val )
					//console.log( i )

				})	

				// console.log('Done');	
	
			}

			/* ------------------------------------
	        ID - LABEL 
	        -------------------------------------*/

	       	// get id and labels for all articles
	        function get_id_label(url) {

	        	$('#content2').append('Id,Label<br/>')

	        	jQuery.each( articles, function( i, val ) {

	        		val_clean = val.replace(/^-+/, '').replace(/-+$/, '').replace('%C7%83', '!').replace(/_/g, ' ').replace('%28', '(').replace('%29', ')').replace('%27', "'");

	        		$('#content2').append('<span class="red">' + val_clean  + '</span>,' + val_clean + '<br/>')

	        		//console.log(val)
	        		$('.hide_1').hide()

	        	})
	        }

	        /* ------------------------------------
	        AMOUNT OF EXIT LINKS
	        -------------------------------------*/
 
			function exitlinks(url) {
			    
			    $.ajax({			    	
		           	type: 'GET',
		           	url: proxy + wikilink + url,
		           	processData: true,
		           	//dataType: 'json',
		           	//crossOrigin: true,
		        })
		        .done (function (get_func) {

		        	container = $('#exitlinks');

		        	var sum = 0

		        	var parsedata_func = $.parseHTML(get_func);

		        	get = []
					get = ($(parsedata_func).find('#mw-content-text').find('a'))

					container.append('<span class="red">' + url + '</span>,' )

					jQuery.each( get, function( i, val ) {

						//var cont = val;	
						var url_clean = url.replace('https://en.wikipedia.org/wiki/','').replace(/^-+/, '').replace(/-+$/, '').replace('%C7%83', '!').replace(/_/g, ' ').replace('%28', '(').replace('%29', ')').replace('%27', "'");

						var findme = window.location.origin + '/wiki/'; //https://en.wikipedia.org/wiki/

						var href = $(val).prop('href');

						var href_clean = href.replace('http://localhost:8888/wiki/','').replace(/_/g, ' ').replace(/,/g, ';');

						if (typeof href === 'string' && href.indexOf(findme) === 0) {
							//container.append ('<span class="red">' + url_clean + '</span>,' + href_clean  + '</br>' ); //val

							

							if (href.indexOf(findme1) !== 0  && href.indexOf(findme2) !== 0 && href.indexOf(findme3) !== 0 && href.indexOf(findme4) !== 0 && href.indexOf(findme5) !== 0 && href.indexOf(findme6) !== 0 && href.indexOf(findme7) !== 0)  {

								//container.append ('<span class="red">' + url_clean + '</span>,' + href_clean  + '</br>' );
								//container.append ('<span class="red">' + url_clean + '</span>,' + href_clean  + '</br>' );
								//container.append ('si-' + href_clean + '<br/>')

								sum++;
							}
							else {
								console.log('no-' + href_clean )
								
							}

						}

					})

					container.append('<span>' + sum + '</span><br/>')
					//console.log(sum)

					$('.hide_1').hide()

				})
				.error (function (xhr, ajaxOptions, thrownError) {
			        console.log(xhr.status);
			        console.log(thrownError);
				});

			}

			// get entry links for one article
			function get_n_exitlink() {

				$('#exitlinks').html('article,exitlinks<br/>')

				jQuery.each( articles, function( i, val ) { //  list

					exitlinks( val )

				})	
	
			}

	        /* ------------------------------------
	        AMOUNT OF ENTRY LINKS
	        -------------------------------------*/
 
			function entrylinks(url) {
			    
			    $.ajax(url, {
	                dataType:  "jsonp",
	                success: function( wikiResponse ) {

	                	//console.log(wikiResponse)

	                	container = $('#entrylinks');

		        		var sum = 0

	                	var parse_back = $.parseHTML(wikiResponse);

	                	back = []
						back = $(wikiResponse.query.backlinks)

						//console.log(back) 

						var art_name = url.replace('https://en.wikipedia.org/w/api.php?action=query&list=backlinks&bllimit=500&format=json&bltitle=','')
						
						//var art_name_clean = string_clean(art_name)
						//var art_name_clean = art_name.replace(/^-+/, '').replace(/-+$/, '').replace('%C7%83', '!').replace(/_/g, ' ').replace('%28', '(').replace('%29', ')').replace('%27', "'");

						container.append('<span class="red">' + art_name + ',</span>' )

						jQuery.each( back, function( i, val ) {

							/*
							var cont = val.title 
							var cont_clean = cont.replace(/,/g, ';')

							$('#content1').append('<span class="red">' + art_name_clean  + '</span>,' + cont_clean + '<br/>') 
							
							*/
							sum++;

						})

						container.append('<span>' + sum + '</span><br/>')

						$('.hide_1').hide()

	                	//console.log(url)

	                },   
					error : function (xhr, ajaxOptions, thrownError) {
				        console.log(xhr.status);
				        console.log(thrownError);
					}
	            })

			}

			// get entry links for one article
			function get_n_entrylink() {

				$('#entrylinks').html('article,entrylinks<br/>')

				jQuery.each( articles, function( i, val ) { // articles; list;

					entrylinks( backlinks + val )

					//console.log( backlinks + val )

				})	
	
			}

		</script>

		<main>
			<div id="title" class="hide_1">
				<h1>Interlinks<h1><!-- <span class="problem">-> remove external links</span> -->
				<h2>Links to other Wikipedia pages</h2>
			</div>
			<div class="box_25">
				<div class="label one hide_1" onclick="get_source_target()">
					<span>Get source-target (edges)</span>
					<!-- to be sure each edge is downloaded see Firebug > Network > Time column-->
				</div><!-- get_all_source_target()-->
				<div id="source_target" class="hide_2"></div>
				<div id="content1" class="hide_2" onclick="hide()"></div>
			</div>

			<div class="box_25">
				<div class="label two hide_1" onclick="get_id_label()">
					<span>Get id-label (nodes)<span>
				</div>
				<div id="id_label" class="hide_2"></div>				
				<div id="content2" class="hide_2" onclick="hide()"></div>
			</div>

			<div class="box_25">
				<div class="label three hide_1" onclick="get_n_entrylink()">
					<span>Get amount of entry links<span>
				</div>
				<div id="entrylinks" class="hide_2"><!--<table></table>--></div>				
				<div id="content2" class="hide_2" onclick="hide()"></div>
			</div>

			<div class="box_25">
				<div class="label one hide_1" onclick="get_n_exitlink()">
					<span>Get amount of exit links<span>
				</div>
				<div id="exitlinks" class="hide_2"></div>				
				<div id="content2" class="hide_2" onclick="hide()"></div>
			</div>

			<div class="clear"></div>
		</main>

	</body>
</html>


<!--

Function for call the proxy
http://goobbe.com/questions/2928320/how-to-call-more-than-one-url-from-one-button-in-jquery-ajax


Convertitore Unix timestamp to Readable Date/time
http://www.onlineconversion.com/unix_time.htm

http://www.4guysfromrolla.com/articles/102710-1.aspx


-->